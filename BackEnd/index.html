<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Map Application - VS Code</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="map-container">
        <div id="control-panel">
            <div id="search-container">
                <input type="text" id="search-input" placeholder="Nháº­p Ä‘á»‹a Ä‘iá»ƒm...">
                <button id="search-btn">ğŸ” TÃ¬m kiáº¿m</button>
                <button id="route-btn">ğŸ›£ï¸ TÃ¬m Ä‘Æ°á»ng</button>
                <button id="current-location-btn">ğŸ“ Vá»‹ trÃ­ tÃ´i</button>
            </div>
            <div id="status">Äang táº£i báº£n Ä‘á»“...</div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- KHá»I Táº O BIáº¾N TOÃ€N Cá»¤C ---
        const map = L.map('map');
        
        // Fix lá»—i map tráº¯ng náº¿u chÆ°a load
        setTimeout(() => map.invalidateSize(), 500);

        // Set vá»‹ trÃ­ máº·c Ä‘á»‹nh
        map.setView([10.762622, 106.660172], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let currentLocation = null;
        let currentMarker = null;
        let routingControl = null;
        let lastSearchedLocation = null;
        let lastSearchMarker = null;

        // --- Láº¤Y Vá»Š TRÃ HIá»†N Táº I (CLIENT SIDE) ---
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        currentLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(currentLocation, 15);

                        if (currentMarker) map.removeLayer(currentMarker);

                        currentMarker = L.marker(currentLocation)
                            .addTo(map)
                            .bindPopup("Vá»‹ trÃ­ cá»§a báº¡n")
                            .openPopup();
                    },
                    error => {
                        alert("KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­: " + error.message);
                    }
                );
            } else {
                alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ xÃ¡c Ä‘á»‹nh vá»‹ trÃ­");
            }
        }

        // --- TÃŒM KIáº¾M (Gá»ŒI FLASK ENDPOINT) ---
        async function searchLocation(query) {
            try {
                // Gá»ŒI ENDPOINT FLASK
                const res = await fetch(`/geo_service/search?q=${encodeURIComponent(query)}`);
                
                if (!res.ok) {
                    const errorData = await res.json();
                    alert("KhÃ´ng tÃ¬m tháº¥y Ä‘á»‹a Ä‘iá»ƒm: " + (errorData.error || res.statusText));
                    return;
                }

                const data = await res.json(); // Nháº­n {lat: ..., lon: ..., display_name: ...} tá»« Flask
                const coords = [data.lat, data.lon];
                
                if (lastSearchMarker) map.removeLayer(lastSearchMarker);

                map.setView(coords, 15);
                lastSearchMarker = L.marker(coords).addTo(map).bindPopup(data.display_name).openPopup();
                lastSearchedLocation = coords;

            } catch (err) {
                console.error("Lá»—i tÃ¬m kiáº¿m:", err);
                alert("Lá»—i káº¿t ná»‘i hoáº·c xá»­ lÃ½ tÃ¬m kiáº¿m.");
            }
        }

        // --- TÃŒM ÄÆ¯á»œNG (Gá»ŒI FLASK ENDPOINT) ---
        async function findRoute() {
            if (!currentLocation) {
                alert("Báº¡n cáº§n láº¥y vá»‹ trÃ­ hiá»‡n táº¡i trÆ°á»›c.");
                return;
            }
            if (!lastSearchedLocation) {
                alert("HÃ£y tÃ¬m kiáº¿m Ä‘á»‹a Ä‘iá»ƒm trÆ°á»›c.");
                return;
            }

            const [s_lat, s_lon] = currentLocation;
            const [d_lat, d_lon] = lastSearchedLocation;

            // XÃ¢y dá»±ng URL cho endpoint Flask tÃ¬m Ä‘Æ°á»ng
            const url = `/geo_service/route?start_lat=${s_lat}&start_lon=${s_lon}&dest_lat=${d_lat}&dest_lon=${d_lon}`;
            
            try {
                // Gá»ŒI ENDPOINT FLASK
                const res = await fetch(url);
                
                if (!res.ok) {
                    const errorData = await res.json();
                    alert("KhÃ´ng thá»ƒ tÃ¬m Ä‘Æ°á»£c Ä‘Æ°á»ng Ä‘i: " + (errorData.error || res.statusText));
                    return;
                }

                const data = await res.json(); // Nháº­n {coordinates: [[lat, lon], ...]} tá»« Flask
                const coords = data.coordinates; 

                if (routingControl) map.removeLayer(routingControl);

                if (coords && coords.length > 0) {
                    routingControl = L.polyline(coords, { color: 'blue', weight: 4 }).addTo(map);
                    map.fitBounds(routingControl.getBounds());
                } else {
                    alert("KhÃ´ng thá»ƒ tÃ¬m Ä‘Æ°á»£c Ä‘Æ°á»ng Ä‘i.");
                }

            } catch (err) {
                console.error("Lá»—i tÃ¬m Ä‘Æ°á»ng:", err);
                alert("Lá»—i káº¿t ná»‘i hoáº·c xá»­ lÃ½ tÃ¬m Ä‘Æ°á»ng.");
            }
        }

        // --- GÃN EVENT ---
        document.getElementById("current-location-btn").onclick = locateUser;
        document.getElementById("search-btn").onclick = () => {
            const q = document.getElementById("search-input").value;
            if (q) searchLocation(q); 
        };
        document.getElementById("route-btn").onclick = findRoute;

        // --- LOAD BAN Äáº¦U ---
        window.onload = () => {
            locateUser();
            setTimeout(() => map.invalidateSize(), 300);
        };
    </script>
</body>
</html>